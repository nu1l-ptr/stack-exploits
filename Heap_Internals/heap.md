# HEAP Exploitation(ptmalloc)

Heap is used for long-lived dynamic allocations of memory. BUT mmap also allocates dynamically. So , malloc is used because mmap allocates memory in multiples of pages (4096 bytes) and mmap includes kernel involvement so it makes it very slow.
  
malloc() - allocate some memmory.  
free() - free prior allocated memory.  
realloc() - change the size of allocation.  
calloc() - allocte and zero out the memory.  

mmap is used for large allocations.

### Chunk

malloc returns `mem_addr` , but ptmalloc tracks `chunk_addr`.

```ASCII
MALLOC CHUNK

-------------------------------------  <------- chunk_addr
| unsigned long mchunk_prev_size;    |  <----- not used in tcache
| unsigned chunk mchunk_size;        |
-------------------------------------- <--------mem_addr
|                                    | 
|   Usable memory(atleast x bytes)   |
|                                    |
|                                    |
--------------------------------------

mchunks_size <------ last 3 bit are used for flags.
                      BIT 0 : PREV_INUSE
                      BIT 1 : IS_MMAPED
                      BIT 2 : NON_MAIN_ARENA

```
* chunk sizes are multiples of 0x10(16).

### tcache 
tcache is the cache layer "Thread Local caching" in ptmalloc to speed up allocations in singel thread.  

* It is singly linked list .

```C
typedef struct tcache_perthread_struct
{ 
  char counts[TCACHE_MAX_BINS];
  tcache_entry *entries[TCACHE_MAX_BINS];
}tcache_perthread_struct;

typedef struct tcache_entry
{
  struct tcache_entry *next;
  struct tcache_perthread_struct *key;
}tcache_entry;

```

* (libc -2.31) `key` is cleared on malloc .

```ASCII
_____________________
|    tache_entry A  |
---------------------
|  next : &B        |
---------------------
|  key : NULL       |  <----on free key becomes zero.
|-------------------|

```

* 64 linked tcache bins whose allocation size is from 16 to 1032 bytes.

```ASCII
FREED TCACHE CHUNK

----------------------------------
|  unsigned long mchunk_prevsize;|
|  unsigne log mchunk_size;      |
---------------------------------
| struct tcache_entry *next;     |
| struct tcache_entry *key       | 
----------------------------------

```
